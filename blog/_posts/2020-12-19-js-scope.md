---
title: 作用域、作用域链及闭包
date: 2020-12-19
tags: 
  - js
  - 作用域
  - 闭包
author: 追旅
location: 杭州滨江 
---

## 前言

最近看了些文章，感觉自己之前对知识的了解还是比较浅的，在此聊一下对```作用域```、```作用域链```及```闭包```新的理解

## 作用域

用一句话来描述：<span style="background: #E6A23C;color: #fff;">作用域就是标识符（变量）在程序中的可见范围</span>

[MDN](https://developer.mozilla.org/zh-CN/docs/Glossary/Scope)是这么解释的：<span style="background: #E6A23C;color: #fff;">当前的执行上下文。值和表达式在其中 "可见" 或可被访问到的上下文</span>

防止把```作用域```和```执行上下文```搞混了，我们还是解释一下它们的关系：```上下文```、```作用域```和环境是同义词，不过```上下文```指代的是整体的执行环境，```作用域```关心的则是标识符的可见性，上下文包含了```this```、```变量环境```和```词法环境```，```作用域```其实是```词法环境```，```作用域链```也可以理解为```词法环境链```，这里引出了```词法环境```，我们稍后解释

```js```中```作用域```是```静态作用域```，也就是```词法作用域```，就是说```作用域```在你书写代码的过程中就已经确定了，用下边的代码来解释一下：

```js
// demo-1
var sex = "男";
function A() {
    console.log(sex) // 男
}
function B() {
    var sex = "女"
    A()
    console.log(A.prototype)
}
B()
// A.prototype打印结果
// [[Scopes]]: Scopes[1]
// 0: Global {window: Window, self: Window, document: document, name: "xw", location: Location, …}
// 可以看出B不在A作用域链上

// demo-2
var sex = "男";
function B() {
    var sex = "女"
    function A() {
        console.log(sex) // 女
    }
    A()
    console.log(A.prototype)
}
B()
// A.prototype打印结果
// [[Scopes]]: Scopes[2]
// 0: Closure (B) {sex: "女"}
// 1: Global {window: Window, self: Window, document: document, name: "xw", location: Location, …}

// 上边连个demo就能够确定，作用域在定义阶段就已经确定了
```

## 词法环境(LexicalEnvironment)

```词法环境```是一种规范类型，基于```ECMAScript```代码的词法嵌套结构来定义变量和函数的关联关系，```执行上下文```创建阶段```词法环境组件```和```变量环境组件```最初是同一个值，在执行环境相关联的代码的执行过程中，变量环境组件永远不变，而词法环境组件有可能改变（对于这句话的解释请看[连接](https://www.imooc.com/wenda/detail/431275)）

* 组成

1. 环境记录（EnvironmentRecord）：储存变量和函数声明的实际位置
2. 对外部环境的引用(Outer)：当前可以访问的外部词法环境，当在环境记录中无法查询到某个变量将会到外部（父级）环境记录表中查询，直到找到为止，如果没有找到将会抛出错误： ```ReferenceError```，

* 类型

1. 全局环境：外部引用为null，环境记录保存着window、关联的方法属性和定义的全局变量
2. 函数环境：外部引用可以是全局环境也可以是外部函数环境，环境记录中保存着函数内定义的变量、函数及arguments

```js
// 全局环境
GlobalExectionContent = {
  LexicalEnvironment: {
    EnvironmentRecord: {
      Type: "Object",
      // 剩余标识符
    },
    Outer: null,
  }
}
// 函数环境
FunctionExectionContent = {
  LexicalEnvironment: {
    EnvironmentRecord: {
      Type: "Declarative",
      // 剩余标识符
    },
    Outer: [Global or outer function environment reference],
  }
}
```

当在一个函数内查询一个变量，会现在当前环境查询，所谓当前环境查询就是在当前词法环境的环境记录中查询，若查不到则到引用的外部环境中查，这也就是我们说的作用域链（词法环境链）





